library(tidyverse)
library(readxl)
library(writexl)
# Loading file
data <- read_excel("besserradfahren-alle-meldungen-datenexport-100.xlsx")
# Converting to data frame
df_og <- data.frame(data)
glimpse(df_og)
View(df_og[1:100,])
add_max_len <- max(str_count(df_og$nächstgelegene.Adresse, ", ")) + 1
df <- df_og %>%
separate(nächstgelegene.Adresse,
into=paste('Ad', 1:add_max_len, sep="_"),
sep=", ")
df <- df %>%
unite(nächstgelegene.Adresse, Ad_10:Ad_1, sep=", ", na.rm=TRUE)
df <- df %>%
separate(nächstgelegene.Adresse,
into=c("Land", "PLZ", "Bundesland", "Kreis", "Ort", "Adresse"),
sep=", ",
extra="merge")
View(df[1:100, ])
head(as.data.frame(table(df$Bundesland)) %>%
arrange(-Freq), 10)
View(df %>% filter(Bundesland == "Baden-Wurtemberg"))
View(df %>% filter(Bundesland == "Bade-Wurtemberg"))
View(df %>% filter(Bundesland == "バーデン＝ヴュルテンベルク州"))
# Transforming columns
df <- df %>%
mutate(
Bundesland=case_when(
Bundesland %in% c("Baden-Wurtemberg","Bade-Wurtemberg") ~ "Baden-Württemberg", TRUE ~ Bundesland),
Ort=case_when(
Ort == "Saint Georges" ~ "Sankt Georgen", TRUE ~ Ort)
)
# Displaying converted
head(as.data.frame(
table(df$Bundesland)) %>%
filter(Freq >= 10) %>%
arrange(-Freq)
)
df <- df %>%
filter(Bundesland == "Baden-Württemberg")
dim(df)
all(str_length(df$PLZ) == 5 )
as.data.frame(table(df$Land)) %>%
arrange(-Freq)
# Removing the incorrect instance
df <- df[df$Land != "Deutschland Kreuzung Wolfartsweierbrücke /Ostring", ]
# Converting all other to "Deutschland"
df$Land <- "Deutschland"
as.data.frame(table(df$Land))
df <- df %>%
mutate(Betroffene = ifelse(is.na(Bestätigungen), 1, Bestätigungen + 1)) # Bestätigungen=NULL would remove original column
View(df[1:100, ])
df <- df %>%
separate(Meldungsgrund,
into=c("grund_a", "grund_b"),
sep=": ",
extra="merge")
View(df[1:100, ])
as.data.frame(table(df$grund_a)) %>% arrange(-Freq)
df <- df[!(df$grund_a %in% c("Sonstige Hinweise", "Positive Meldung")), ] # slicing with the NOT and IN operators
# Inspecting result
as.data.frame(table(df$grund_a)) %>% arrange(-Freq)
as.data.frame(table(df$Status)) %>% arrange(-Freq)
df$Status <- "negative Meldung"
# Creating a clean subset
df_c <- df %>%
filter(Kreis=="Aichtal") %>%
separate(Adresse,
into=c("Ort_new", "Adresse"),
sep=", ",
extra="merge")
df_c$Kreis <- NULL
df_c <- df_c %>% rename("Kreis"="Ort", "Ort"="Ort_new")
# Replacing data int the big dataframe with values from the clean subset
df$Kreis[match(df_c$ID, df$ID)] <- df_c$Kreis
df$Ort[match(df_c$ID, df$ID)] <- df_c$Ort
df$Adresse[match(df_c$ID, df$ID)] <- df_c$Adresse
df_bw <- df %>%
select(ID,
#Status,
#Land,
PLZ,
#Bundesland,
Kreis,
Ort,
#Adresse,
grund_a,
grund_b,
Zeitpunkt.der.Meldung,
#weitere.Angaben,
#Dateien,
lat,
lon,
#Bestätigungen,
Betroffene)
View(df_bw)
df_bw <- df %>%
select(ID,
#Status,
#Land,
PLZ,
#Bundesland,
Kreis,
Ort,
#Adresse,
grund_a,
grund_b,
Zeitpunkt.der.Meldung,
#weitere.Angaben,
#Dateien,
lat,
lon,
#Bestätigungen,
Betroffene)
View(df_bw[1:100, ])
df_bw <- df_bw[rowSums(is.na(df_bw)) == 0, ]
write_xlsx(df_bw, "cycling_bw_clean.xlsx")
time_window <- as.Date(df_bw$Zeitpunkt.der.Meldung)
time_window <- paste(format(time_window[1], "%d.%b.%Y"), "-", format(rev(time_window)[1], "%d.%b.%Y"))
time_window
# Creating a summary for Stuttgart
s_grund_a <- df_bw %>%
filter(Kreis=="Stuttgart") %>%
group_by(grund_a) %>%
summarise(Personen=sum(Betroffene))
s <- sum(s_grund_a$Personen)
s_grund_a <- s_grund_a %>% mutate(Stuttgart = round(Personen / s * 100, 2), Personen=NULL)
# Creating a summary for BW
bw_grund_a <- df_bw %>%
group_by(grund_a) %>%
summarise(Personen=sum(Betroffene)) %>%
mutate(BW=round(Personen / sum(Personen) * 100, 2), Personen=NULL)
# Merging
s_bw <- merge(s_grund_a, bw_grund_a)
s_bw
pivot_longer(s_bw, Stuttgart:BW) %>%
ggplot(aes(x=value,
y=reorder(grund_a, value),
fill=name)) +
geom_bar(stat="identity", position="dodge", width=0.7, alpha=0.9) +
scale_fill_manual(values=c("#F9DD16", "#000000"),
name=NULL) +
theme(legend.position="top", plot.caption=element_text(size=8)) +
labs(title="Baden-Württemberg vs. Stuttgart",
subtitle="Probleme der Radfahrer nach Kategorie",
caption=time_window,
x="Anteil (%)",
y="Kategorie")
ggsave(filename="1_bw_vs_stuttgart.png", width=8, height=4, dpi=400)
s_dist <- df_bw %>%
filter(Ort %in% c("Stuttgart-Mitte",
"Stuttgart-Nord",
"Stuttgart-Ost",
"Stuttgart-Süd",
"Stuttgart-West")) %>%
group_by(Ort, grund_a) %>%
summarise(Personen=sum(Betroffene))
View(s_dist)
clr <- c("#C8392B", "#489FD8", "#E3BD3F", "#205093", "#42954A")
s_dist %>%
ggplot(aes(x=reorder(Ort, -Personen),
y=Personen,
fill=grund_a)) +
geom_bar(stat="identity", position="stack", width=0.6) +
scale_fill_manual(values=clr, name=NULL) +
theme(plot.caption=element_text(size=8)) +
labs(title="Stuttgart: Innere Stadtbezirke",
subtitle="Probleme der Radfahrer nach Kategorie",
caption=time_window,
x="Bezirk",
y="Betroffene Personen")
ggsave(filename="2_stuttgart_inner_dist.png", width=8, height=4, dpi=400)
time_s <- df_bw %>%
filter(Kreis=="Stuttgart") %>%
mutate(Datum=as.Date(Zeitpunkt.der.Meldung)) %>%
group_by(grund_a, Datum) %>%
summarize(Personen=sum(Betroffene)) %>%
mutate(Pct=round(Personen / max(Personen) * 100, 0), Personen=NULL)
time_s <- time_s %>% pivot_wider(names_from = Datum, values_from = Pct)
time_s[is.na(time_s)] <- 0
time_s <- pivot_longer(test, colnames(time_s)[2]:rev(colnames(time_s))[1], names_to="Datum", values_to="Pct")
time_s <- time_s %>% pivot_wider(names_from = Datum, values_from = Pct)
time_s <- df_bw %>%
filter(Kreis=="Stuttgart") %>%
mutate(Datum=as.Date(Zeitpunkt.der.Meldung)) %>%
group_by(grund_a, Datum) %>%
summarize(Personen=sum(Betroffene)) %>%
mutate(Pct=round(Personen / max(Personen) * 100, 0), Personen=NULL)
View(time_s)
time_s <- time_s %>% pivot_wider(names_from = Datum, values_from = Pct)
time_s[is.na(time_s)] <- 0
time_s <- pivot_longer(time_s, colnames(time_s)[2]:rev(colnames(time_s))[1], names_to="Datum", values_to="Pct")
time_s$Datum <- as.Date(time_s$Datum)
time_s <- time_s %>%
arrange(Datum)
View(time_s)
time_s <- df_bw %>%
filter(Kreis=="Stuttgart") %>%
mutate(Datum=as.Date(Zeitpunkt.der.Meldung)) %>%
group_by(grund_a, Datum) %>%
summarize(Personen=sum(Betroffene)) %>%
mutate(Pct=round(Personen / max(Personen) * 100, 0), Personen=NULL)
time_s <- time_s %>% pivot_wider(names_from = Datum, values_from = Pct)
time_s[is.na(time_s)] <- 0
time_s <- pivot_longer(time_s, colnames(time_s)[2]:rev(colnames(time_s))[1], names_to="Datum", values_to="Pct")
time_s$Datum <- as.Date(time_s$Datum)
time_s <- time_s %>%
arrange(Datum)
View(time_s)
time_s %>%
ggplot(aes(x=Datum, y=Pct, color=grund_a)) +
geom_smooth(method="loess", se=FALSE) +
scale_color_manual(values=clr, name=NULL) +
theme(legend.position="top", legend.key.width=unit(8, "pt"), plot.caption=element_text(size=8)) +
scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
labs(title="Stuttgart: Trend über 3 Monate",
subtitle="Probleme der Radfahrer nach Kategorie",
caption=time_window,
x="Datum",
y="Trend (%)")
ggsave(filename="3_stuttgart_trend.png", width=8, height=4, dpi=400)
regions <- df_bw %>%
filter(Kreis %in% c("Stuttgart",
"Mannheim",
"Karlsruhe",
"Freiburg im Breisgau",
"Heidelberg")) %>%
group_by(Kreis, grund_a) %>%
summarise(Personen=sum(Betroffene)) %>%
mutate(Pct=round(Personen / sum(Personen) * 100, 2))
ord <- c("Stuttgart",
"Mannheim",
"Karlsruhe",
"Freiburg im Breisgau",
"Heidelberg")
clr <- c("#C8392B", "#489FD8", "#E3BD3F", "#205093", "#42954A")
regions %>%
ggplot(aes(x=Pct,
y=fct_relevel(Kreis, rev(ord)),
fill=grund_a)) +
geom_bar(stat="identity", position="stack") +
scale_fill_manual(values=clr, name=NULL) +
theme(plot.caption=element_text(size=8)) +
labs(title="BW: Top 5 der bevölkerungreichsten Städte",
subtitle="Probleme der Radfahrer nach Kategorie",
caption=time_window,
x="Anteil (%)",
y="Stadt")
ggsave(filename="4_bw_top5.png", width=8, height=4, dpi=400)
library(tidyverse)
library(readxl)
library(writexl)
# Loading file
data <- read_excel("besserradfahren-alle-meldungen-datenexport-100.xlsx")
# Converting to data frame
df_og <- data.frame(data)
# Loading file
data <- read_excel("data/besserradfahren-alle-meldungen-datenexport-100.xlsx")
# Loading file
data <- read_excel("data\besserradfahren-alle-meldungen-datenexport-100.xlsx")
# Loading file
data <- read_excel("data/besserradfahren-alle-meldungen-datenexport-100.xlsx")
# Converting to data frame
df_og <- data.frame(data)
library(tidyverse)
library(readxl)
library(writexl)
# Loading file
data <- read_excel("data/besserradfahren-alle-meldungen-datenexport-100.xlsx")
# Converting to data frame
df_og <- data.frame(data)
glimpse(df_og)
View(df_og[1:100,])
add_max_len <- max(str_count(df_og$nächstgelegene.Adresse, ", ")) + 1
df <- df_og %>%
separate(nächstgelegene.Adresse,
into=paste('Ad', 1:add_max_len, sep="_"),
sep=", ")
df <- df %>%
unite(nächstgelegene.Adresse, Ad_10:Ad_1, sep=", ", na.rm=TRUE)
df <- df %>%
separate(nächstgelegene.Adresse,
into=c("Land", "PLZ", "Bundesland", "Kreis", "Ort", "Adresse"),
sep=", ",
extra="merge")
View(df[1:100, ])
head(as.data.frame(table(df$Bundesland)) %>%
arrange(-Freq), 10)
View(df %>% filter(Bundesland == "Baden-Wurtemberg"))
View(df %>% filter(Bundesland == "Bade-Wurtemberg"))
View(df %>% filter(Bundesland == "バーデン＝ヴュルテンベルク州"))
# Transforming columns
df <- df %>%
mutate(
Bundesland=case_when(
Bundesland %in% c("Baden-Wurtemberg","Bade-Wurtemberg") ~ "Baden-Württemberg", TRUE ~ Bundesland),
Ort=case_when(
Ort == "Saint Georges" ~ "Sankt Georgen", TRUE ~ Ort)
)
# Displaying converted
head(as.data.frame(
table(df$Bundesland)) %>%
filter(Freq >= 10) %>%
arrange(-Freq)
)
df <- df %>%
filter(Bundesland == "Baden-Württemberg")
dim(df)
all(str_length(df$PLZ) == 5 )
as.data.frame(table(df$Land)) %>%
arrange(-Freq)
# Removing the incorrect instance
df <- df[df$Land != "Deutschland Kreuzung Wolfartsweierbrücke /Ostring", ]
# Converting all other to "Deutschland"
df$Land <- "Deutschland"
as.data.frame(table(df$Land))
df <- df %>%
mutate(Betroffene = ifelse(is.na(Bestätigungen), 1, Bestätigungen + 1)) # Bestätigungen=NULL would remove original column
df <- df %>%
separate(Meldungsgrund,
into=c("grund_a", "grund_b"),
sep=": ",
extra="merge")
as.data.frame(table(df$grund_a)) %>% arrange(-Freq)
df <- df[!(df$grund_a %in% c("Sonstige Hinweise", "Positive Meldung")), ] # slicing with the NOT and IN operators
# Inspecting result
as.data.frame(table(df$grund_a)) %>% arrange(-Freq)
as.data.frame(table(df$Status)) %>% arrange(-Freq)
df$Status <- "negative Meldung"
# Creating a clean subset
df_c <- df %>%
filter(Kreis=="Aichtal") %>%
separate(Adresse,
into=c("Ort_new", "Adresse"),
sep=", ",
extra="merge")
df_c$Kreis <- NULL
df_c <- df_c %>% rename("Kreis"="Ort", "Ort"="Ort_new")
# Replacing data int the big dataframe with values from the clean subset
df$Kreis[match(df_c$ID, df$ID)] <- df_c$Kreis
df$Ort[match(df_c$ID, df$ID)] <- df_c$Ort
df$Adresse[match(df_c$ID, df$ID)] <- df_c$Adresse
df_bw <- df %>%
select(ID,
#Status,
#Land,
PLZ,
#Bundesland,
Kreis,
Ort,
#Adresse,
grund_a,
grund_b,
Zeitpunkt.der.Meldung,
#weitere.Angaben,
#Dateien,
lat,
lon,
#Bestätigungen,
Betroffene)
View(df_bw[1:100, ])
df_bw <- df_bw[rowSums(is.na(df_bw)) == 0, ]
write_xlsx(df_bw, "data/cycling_bw_clean.xlsx")
time_window <- as.Date(df_bw$Zeitpunkt.der.Meldung)
time_window <- paste(format(time_window[1], "%d.%b.%Y"), "-", format(rev(time_window)[1], "%d.%b.%Y"))
time_window
# Creating a summary for Stuttgart
s_grund_a <- df_bw %>%
filter(Kreis=="Stuttgart") %>%
group_by(grund_a) %>%
summarise(Personen=sum(Betroffene))
s <- sum(s_grund_a$Personen)
s_grund_a <- s_grund_a %>% mutate(Stuttgart = round(Personen / s * 100, 2), Personen=NULL)
# Creating a summary for BW
bw_grund_a <- df_bw %>%
group_by(grund_a) %>%
summarise(Personen=sum(Betroffene)) %>%
mutate(BW=round(Personen / sum(Personen) * 100, 2), Personen=NULL)
# Merging
s_bw <- merge(s_grund_a, bw_grund_a)
s_bw
pivot_longer(s_bw, Stuttgart:BW) %>%
ggplot(aes(x=value,
y=reorder(grund_a, value),
fill=name)) +
geom_bar(stat="identity", position="dodge", width=0.7, alpha=0.9) +
scale_fill_manual(values=c("#F9DD16", "#000000"),
name=NULL) +
theme(legend.position="top", plot.caption=element_text(size=8)) +
labs(title="Baden-Württemberg vs. Stuttgart",
subtitle="Probleme der Radfahrer nach Kategorie",
caption=time_window,
x="Anteil (%)",
y="Kategorie")
ggsave(path="images", filename="1_bw_vs_stuttgart.png", width=8, height=4, dpi=400)
s_dist <- df_bw %>%
filter(Ort %in% c("Stuttgart-Mitte",
"Stuttgart-Nord",
"Stuttgart-Ost",
"Stuttgart-Süd",
"Stuttgart-West")) %>%
group_by(Ort, grund_a) %>%
summarise(Personen=sum(Betroffene))
clr <- c("#C8392B", "#489FD8", "#E3BD3F", "#205093", "#42954A")
s_dist %>%
ggplot(aes(x=reorder(Ort, -Personen),
y=Personen,
fill=grund_a)) +
geom_bar(stat="identity", position="stack", width=0.6) +
scale_fill_manual(values=clr, name=NULL) +
theme(plot.caption=element_text(size=8)) +
labs(title="Stuttgart: Innere Stadtbezirke",
subtitle="Probleme der Radfahrer nach Kategorie",
caption=time_window,
x="Bezirk",
y="Betroffene Personen")
ggsave(path="images", filename="2_stuttgart_inner_dist.png", width=8, height=4, dpi=400)
time_s <- df_bw %>%
filter(Kreis=="Stuttgart") %>%
mutate(Datum=as.Date(Zeitpunkt.der.Meldung)) %>%
group_by(grund_a, Datum) %>%
summarize(Personen=sum(Betroffene)) %>%
mutate(Pct=round(Personen / max(Personen) * 100, 0), Personen=NULL)
time_s <- time_s %>% pivot_wider(names_from = Datum, values_from = Pct)
time_s[is.na(time_s)] <- 0
time_s <- pivot_longer(time_s, colnames(time_s)[2]:rev(colnames(time_s))[1], names_to="Datum", values_to="Pct")
time_s$Datum <- as.Date(time_s$Datum)
time_s <- time_s %>%
arrange(Datum)
time_s %>%
ggplot(aes(x=Datum, y=Pct, color=grund_a)) +
geom_smooth(method="loess", se=FALSE) +
scale_color_manual(values=clr, name=NULL) +
theme(legend.position="top", legend.key.width=unit(8, "pt"), plot.caption=element_text(size=8)) +
scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
labs(title="Stuttgart: Trend über 3 Monate",
subtitle="Probleme der Radfahrer nach Kategorie",
caption=time_window,
x="Datum",
y="Trend (%)")
ggsave(path="images", filename="3_stuttgart_trend.png", width=8, height=4, dpi=400)
regions <- df_bw %>%
filter(Kreis %in% c("Stuttgart",
"Mannheim",
"Karlsruhe",
"Freiburg im Breisgau",
"Heidelberg")) %>%
group_by(Kreis, grund_a) %>%
summarise(Personen=sum(Betroffene)) %>%
mutate(Pct=round(Personen / sum(Personen) * 100, 2))
ord <- c("Stuttgart",
"Mannheim",
"Karlsruhe",
"Freiburg im Breisgau",
"Heidelberg")
clr <- c("#C8392B", "#489FD8", "#E3BD3F", "#205093", "#42954A")
regions %>%
ggplot(aes(x=Pct,
y=fct_relevel(Kreis, rev(ord)),
fill=grund_a)) +
geom_bar(stat="identity", position="stack") +
scale_fill_manual(values=clr, name=NULL) +
theme(plot.caption=element_text(size=8)) +
labs(title="BW: Top 5 der bevölkerungreichsten Städte",
subtitle="Probleme der Radfahrer nach Kategorie",
caption=time_window,
x="Anteil (%)",
y="Stadt")
ggsave(path="images", filename="4_bw_top5.png", width=8, height=4, dpi=400)
ord <- c("Stuttgart",
"Mannheim",
"Karlsruhe",
"Freiburg im Breisgau",
"Heidelberg")
clr <- c("#C8392B", "#489FD8", "#E3BD3F", "#205093", "#42954A")
regions %>%
ggplot(aes(x=Pct,
y=fct_relevel(Kreis, rev(ord)),
fill=grund_a)) +
geom_bar(stat="identity", position="stack") +
scale_fill_manual(values=clr, name=NULL) +
theme(plot.caption=element_text(size=8)) +
labs(title="BW: Top 5 der bevölkerungsreichsten Städte",
subtitle="Probleme der Radfahrer nach Kategorie",
caption=time_window,
x="Anteil (%)",
y="Stadt")
ggsave(path="images", filename="4_bw_top5.png", width=8, height=4, dpi=400)
